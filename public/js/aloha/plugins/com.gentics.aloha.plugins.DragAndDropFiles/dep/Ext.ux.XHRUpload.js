Ext.ns("Ext.ux");Ext.ux.XHRUpload=function(config){Ext.apply(this,config,{method:"POST",fileNameHeader:"X-File-Name",filePostName:"fileName",contentTypeHeader:"text/plain; charset=x-user-defined-binary",extraPostData:{},extraHeaders:{},xhrExtraPostDataPrefix:"extraPostData_",sendMultiPartFormData:false});this.addEvents("loadstart","progress","abort","error","load","loadend");Ext.ux.XHRUpload.superclass.constructor.call(this)};Ext.extend(Ext.ux.XHRUpload,Ext.util.Observable,{send:function(config){Ext.apply(this,config);this.xhr=new XMLHttpRequest();this.xhr.addEventListener("loadstart",this.relayXHREvent.createDelegate(this),false);this.xhr.addEventListener("progress",this.relayXHREvent.createDelegate(this),false);this.xhr.addEventListener("progressabort",this.relayXHREvent.createDelegate(this),false);this.xhr.addEventListener("error",this.relayXHREvent.createDelegate(this),false);this.xhr.addEventListener("load",this.relayXHREvent.createDelegate(this),false);this.xhr.addEventListener("loadend",this.relayXHREvent.createDelegate(this),false);this.xhr.upload.addEventListener("loadstart",this.relayUploadEvent.createDelegate(this),false);this.xhr.upload.addEventListener("progress",this.relayUploadEvent.createDelegate(this),false);this.xhr.upload.addEventListener("progressabort",this.relayUploadEvent.createDelegate(this),false);this.xhr.upload.addEventListener("error",this.relayUploadEvent.createDelegate(this),false);this.xhr.upload.addEventListener("load",this.relayUploadEvent.createDelegate(this),false);this.xhr.upload.addEventListener("loadend",this.relayUploadEvent.createDelegate(this),false);this.xhr.open(this.method,this.url,true);if(typeof(FileReader)!=="undefined"&&this.sendMultiPartFormData){this.reader=new FileReader();this.reader.addEventListener("load",this.sendFileUpload.createDelegate(this),false);this.reader.readAsBinaryString(this.file);return true}this.xhr.overrideMimeType(this.contentTypeHeader);this.xhr.setRequestHeader(this.fileNameHeader,this.file.name);console.log(this.xhr);for(var attr in this.extraHeaders){this.xhr.setRequestHeader(attr,this.extraHeaders[attr])}for(var attr in this.extraPostData){this.xhr.setRequestHeader(this.xhrExtraPostDataPrefix+attr,this.extraPostData[attr])}this.xhr.send(this.file);return true},sendFileUpload:function(){var boundary=(1000000000000+Math.floor(Math.random()*8999999999998)).toString(),data="";for(attr in this.extraPostData){data+="--"+boundary+'\r\nContent-Disposition: form-data; name="'+attr+'"\r\ncontent-type: text/plain;\r\n\r\n'+this.extraPostData[attr]+"\r\n"}data+="--"+boundary+'\r\nContent-Disposition: form-data; name="'+this.filePostName+'"; filename="'+this.file.name+'"\r\nContent-Type: '+this.file.type+"\r\nContent-Transfer-Encoding: base64\r\n\r\n"+window.btoa(this.reader.result)+"\r\n--"+boundary+"--\r\n\r\n";this.xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+boundary);this.xhr.send(data)},relayUploadEvent:function(event){this.fireEvent("upload"+event.type,event)},relayXHREvent:function(event){this.fireEvent(event.type,event)}});